|  练习1 |  调试工作空间 |
| :--- | :--- |
| 数据 | 地址（Esri地理数据库） 犯罪数据（CSV - 逗号分隔值） 公园（MapInfo TAB） 游泳池（OSM - OpenStreetMap） |
| 总体目标 | 参与温哥华步行性项目 |
| 演示 | 调试最佳实践 |
| 启动工作空间 | C:\FMEData2019\Workspaces\DesktopBasic\BestPractice-Ex3-Begin.fmwt |
| 结束工作空间 | C:\FMEData2019\Workspaces\DesktopBasic\BestPractice-Ex3-Complete.fmwt |

继续上一个练习，您已被分配到一个项目，以计算温哥华市每个地址的“步行性”。步行性衡量步行访问当地设施的难易程度。该工作空间目前正在评估犯罪，公园和噪音控制区域，但并未对步行性进行全面衡量。

所以，让我们这样做，然后看看是否还有其他方面可以包括。

---

<br>**1) 启动FME Workbench**
<br>启动FME Workbench。打开工作空间模板 C:\FMEData2019\Workspaces\DesktopBasic\BestPractice-Ex1-Begin.fmw. 然后运行工作区以缓存数据。

这个工作空间有点混乱，但是我们将在以后的练习中修复它。首先，让我们弄清楚该工作空间的作用：

![](./Images/Img5.200.Ex1.WorkspaceOverview.png)

1. 正在从Addresses.gdb中读取PostalAddress和PostcodeBoundaries。
2. 正在清理PostalAddress要素类型的属性以创建单独的Number和Street属性。然后将数字的最后两位数字替换为XX，以创建一个属性，该属性将成为用于联接犯罪数据的联接关键字。
3. 读入Crime.csv后，每个犯罪事件的街道号都以XX作为最后两位数字来保护。
4. 基于2.中创建的Join Key属性和Crime的Block属性，在FeatureJoiner中将PostalAddress和Crime数据连接在一起。
5. 根据严重性为[crime] 类别属性指定一个数字，然后为每个地址块计算总的CrimeValue。然后，使用CenterPointReplacer，如果同一位置有多个犯罪事件，则仅提取一个点。
6. 读入公园MapInfo TAB文件。这将用于测量从地址到公园的步行距离。
7. 使用NeighborFinder确定最靠近每个地址的公园。
8. 使用NeighborFinder创建的_distance属性重命名为ParkDistance。
9. 使用Creator和FeatureReader读取计划限制Planning Restrictions OGC Geopackage。然后从该数据集中读取NoiseControlAreas，以获得噪声限制区域。该数据将与犯罪和住址数据结合在一起。
10. 使用PointOnAreaOverlayer，可以将包含犯罪，停车距离和地址的点数据与NoiseControlAreas多边形结合在一起。这会将噪声限制分配给任何重叠点。AttributeValueMapper用于为区域分配分数，从而创建属性NoiseZoneScore。此新属性将反映出，在噪声受限区域中更适合步行的地址。

---

<!--Tip Section-->

<table style="border-spacing: 0px">
<tr>
<td style="vertical-align:middle;background-color:darkorange;border: 2px solid darkorange">
<i class="fa fa-info-circle fa-lg fa-pull-left fa-fw" style="color:white;padding-right: 12px;vertical-align:text-top"></i>
<span style="color:white;font-size:x-large;font-weight: bold;font-family:serif">技巧</span>
</td>
</tr>

<tr>
<td style="border: 1px solid darkorange">
<span style="font-family:serif; font-style:italic; font-size:larger">
这个工作空间非常混乱，因为我们的同事没有遵循任何最佳实践。我们将在以后的练习中对其进行清理，但是如果您难以理解处于混乱状态，请单击“自动布局(Autolayout)”按钮以快速整理它：
<br>
<img src ="./Images/Img5.200a.Ex1.AutoLayout.png">
<br><br>
 <strong>请注意，与屏幕截图和培训老师相比，这将改变工作空间的外观， 因此请注意转换器的名称和端口： </strong>
<br><br>
<img src="./Images/Img5.200b.Ex1.AutoLayoutWorkspace.png">
</span>
</td>
</tr>
</table>

---

<br>**2) Add an ExpressionEvaluator Transformer**
<br>We can create a measure of walkability that combines all of our current values using the ExpressionEvaluator transformer.

So add an ExpressionEvaluator transformer to the end of the workspace and connect it to the AttributeValueMapper&#95;2.

Inspect its parameters. Set it up to create a new attribute called Walkability that is:

<pre>
@Value(ParkDistance) + @Value(CrimeValue) - @Value(NoiseZoneScore)
</pre>

![](./Images/Img5.201.Ex1.ExpressionEvaluatorDialog.png)

With this expression, the smaller the result, the better. Run the workspace. Because we ran the workspace in the beginning to cache all the data, only the ExpressionEvaluator will run.


<br>**3) Assess the Result**
<br>Let's assess whether the result of the translation is correct.

Firstly check the log window for errors and warnings. There are no errors, but there are several warnings, which is not a good sign:

![](./Images/Img5.202.Ex1.TranslationLogWarnings.png)

***Note:*** *The number of warnings showed in the Translation Log may be different, this is based on the Logging Parameters set in FME Options.*

Click on the warnings button to filter out the warnings. The warnings say:

<pre>
ExpressionEvaluator: Failed to evaluate expression '@real64(560.3272250455418+&lt;null&gt;-0)'.
Result is set to null
</pre>

Inspect the output cache on the ExpressionEvaluator, and some addresses do indeed have a Walkability value of &lt;null&gt;.

So we know there is a problem, let's try and figure out where the problem is and why it occurs.

---

<!--Tip Section-->

<table style="border-spacing: 0px">
<tr>
<td style="vertical-align:middle;background-color:darkorange;border: 2px solid darkorange">
<i class="fa fa-info-circle fa-lg fa-pull-left fa-fw" style="color:white;padding-right: 12px;vertical-align:text-top"></i>
<span style="color:white;font-size:x-large;font-weight: bold;font-family:serif">TIP</span>
</td>
</tr>

<tr>
<td style="border: 1px solid darkorange">
<span style="font-family:serif; font-style:italic; font-size:larger">
A useful test would be to right-click on CrimeValue in the Table View window, and sort by ascending numeric order. That will put any null values to the top of the table.
</span>
</td>
</tr>
</table>

---

<br>**4) Locate the Problem**
<br>We can tell the warning comes from the ExpressionEvaluator, but that doesn't necessarily mean that is where the problem lies. The calculation fails because the middle value is &lt;null&gt;


If the expression is:

<pre>
ParkDistance + CrimeValue - NoiseZoneScore
</pre>

Then we know that it must be the CrimeValue that is an issue because it is the middle value.

Let's find out where it becomes an issue. First, organize the workspace a bit, and then inspect the caches on the FeatureJoiner transformer. We are inspecting the FeatureJoiner because that's where we first get our Crime data:

![](./Images/Img5.203.Ex1.FeatureJoinerOutputs.png)

There are no &lt;null&gt; values coming from the FeatureJoiner, so let's move along the translation. Check the cache for the AttributeValueMapper. That's where values are set, so perhaps nulls are coming out of there?

On inspection, there are no &lt;null&gt; values for the CrimeValue or the crime Type attribute in there. There are also no nulls for the Aggregator and CenterPointReplacer caches.

Checking each feature cache is a bit time consuming, let's try a different method. Check the feature counts on each connection. There are 68,446 features tagged with a crime (FeatureJoiner:Joined), but then that is reduced to 9,899 after the Aggregator and then there are 3,698 features that are not tagged with a crime (FeatureJoiner:UnjoinedLeft). That gives a total of 13,597, coming out of the NeighborFinder, which is correct.

Oh. Do you see it yet? The 3,698 features that are not tagged with a crime: what CrimeValue do they get? Inspect the UnjoinedLeft output from the FeatureJoiner, and you will see that they do not have the CrimeValue attribute. That's why the ExpressionEvaluator says that there are nulls. The reason these features do not have a value for CrimeValue, is because they are not being routed through the AttributeValueMapper which assigns the CrimeValue a value. 

---

<!--Tip Section-->

<table style="border-spacing: 0px">
<tr>
<td style="vertical-align:middle;background-color:darkorange;border: 2px solid darkorange">
<i class="fa fa-info-circle fa-lg fa-pull-left fa-fw" style="color:white;padding-right: 12px;vertical-align:text-top"></i>
<span style="color:white;font-size:x-large;font-weight: bold;font-family:serif">FME Lizard says...</span>
</td>
</tr>

<tr>
<td style="border: 1px solid darkorange">
<span style="font-family:serif; font-style:italic; font-size:larger">
To confirm this I copied the log into a text editor and searched for the phrase "ExpressionEvaluator: Failed to evaluate expression".
<br>It appeared 3,698 times, the same as the number of features that exit the UnjoinedLeft port. Coincidence?
</span>
</td>
</tr>
</table>

---

<br>**5) Fix the Problem**
<br>If those features do not have a CrimeValue attribute, then we should give them one. To do so, add an AttributeCreator transformer to the workspace between the FeatureJoiner:UnjoinedLeft output port and the NeighborFinder:Base input port:

![](./Images/Img5.204.Ex1.AttributeCreatorOnCanvas.png)

Open up its parameters and create an attribute called CrimeValue with a value of zero (0).

![](./Images/Img5.205.Ex1.AttributeCreatorParams.png)

Run the workspace, which will run from the AttributeCreator to the ExpressionEvaluator. You should now find that there are fewer warnings and that the output contains no &lt;null&gt; values.

<br>**6) Add Swimming Pools**
<br>The city has decided that parks are not a great candidate for walkability scores because there is usually a park nearby. They decided to evaluate how easy it is to walk to a swimming pool, and this evaluation might be used to decide later where a new pool should be built.

We can reuse the same workflow for swimming pools that was built for parks, with just a few minor updates.

First let's add a new reader with the following parameters:

<table style="border: 0px">

<tr>
<td style="font-weight: bold">Reader Format</td>
<td style="">OpenStreetMap (OSM) XML</td>
</tr>

<tr>
<td style="font-weight: bold">Reader Dataset</td>
<td style="">C:\FMEData2019\Data\OpenStreetMap\leisure.osm</td>
</tr>

</table>

When prompted, select only the leisure feature type:

![](./Images/Img5.206.Ex1.LeisureFeatureType.png)

Then move the new leisure reader near the Parks reader and connect it to the NeighborFinder:Candidate input port. Then right-click on the Parks reader and select disable.


<br>**7) Filter Leisure Data**
<br>If you inspect the leisure data, you'll notice that there are various types of leisure facility, the type being recorded in the *leisure* attribute.

So, add a Tester transformer between the leisure reader and the NeighborFinder. Set up the parameters to test for leisure = swimming_pool

![](./Images/Img5.207.Ex1.SwimmingPoolTester.png)

<br>**8) Update Transformer Parameters**
<br>Now update AttributeRenamer to be PoolDistance instead of ParkDistance. The renaming of this attribute will cause the ExpressionEvaluator to turn red.

To fix the ExpressionEvaluator, open the parameters and change @Value(ParkDistance) to @Value(PoolDistance) to take account of the new PoolDistance attribute:

<pre>
@Value(PoolDistance) + @Value(CrimeValue) - @Value(NoiseZoneScore)
</pre>

Re-run the workspace. Check the log for warnings and errors, and then inspect the ExpressionEvaluator cache.

Notice that the walkability scores are exceedingly large all of a sudden, due to the PoolDistance. Something is wrong, but what?


<br>**9) Locate Problem**
<br>The PoolDistance is the source of the problem. There is no related log message to give a clue, and the Feature Count numbers look correct.

Let's inspect the data. Click on the leisure reader and while holding the <kbd>shift</kbd> key, click on the NeighborFinder. Then right-click on either object and select Inspect Cached Features. This will open all the selected caches in Visual Preview.

Right-click in the Graphics view, go to Background Map and ensure Background map off is selected. Visual Preview shows two specks of data, a long distance apart. This result is typical of a mismatch of coordinate systems.

Click on some features and select the Feature Information button. In this window you will see that the main data has a coordinate system of UTM83-10, while the leisure data from OSM has a coordinate system of LL84.

This disparity is why the "nearest" pool to each address is such a high distance.


<br>**10) Fix Coordinate System Problem**
<br>The obvious solution is to reproject the pools to the correct coordinate system. So, add a Reprojector transformer to reproject the leisure data before it gets to the NeighborFinder:

![](./Images/Img5.208.Ex1.ReprojectorOnCanvas.png)

Inspect its parameters and set it up to reproject from LL84 to UTM83-10.

Re-run the appropriate parts of the workspace. Check the log window and inspect the ExpressionEvaluator cache.

Each address now has a walkability score account for pools instead of parks, with a lower number being better and a higher number worse.

---

<!--Exercise Congratulations Section-->

<table style="border-spacing: 0px">
<tr>
<td style="vertical-align:middle;background-color:darkorange;border: 2px solid darkorange">
<i class="fa fa-thumbs-o-up fa-lg fa-pull-left fa-fw" style="color:white;padding-right: 12px;vertical-align:text-top"></i>
<span style="color:white;font-size:x-large;font-weight: bold;font-family:serif">CONGRATULATIONS</span>
</td>
</tr>

<tr>
<td style="border: 1px solid darkorange">
<span style="font-family:serif; font-style:italic; font-size:larger">
By completing this exercise you have learned how to:
<br>
<ul><li>use the ExpressionEvaluator transformer</li>
<li>Check the log window for errors and warnings</li>
<li>Locate problems through use of Feature Counts and Visual Preview</li>
<li>Identify and fix problems in a workspace</li></ul>
</span>
</td>
</tr>
</table>
